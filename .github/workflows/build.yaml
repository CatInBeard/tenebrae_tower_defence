name: "godot-ci"
on: push

# https://github.com/abarichello/godot-ci

permissions:
  contents: write
  pages: write
  id-token: write

env:
  GODOT_VERSION: 4.5
  EXPORT_NAME: tenebrae-tower-defence
  PROJECT_PATH: .

jobs:
    export-linux:
        name: Linux Export
        runs-on: ubuntu-24.04
        container:
            image: barichello/godot-ci:4.5
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                lfs: true
            - name: Setup
              run: |
                mkdir -v -p ~/.local/share/godot/export_templates/
                mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
            - name: Linux Build
              run: |
                mkdir -v -p build/linux
                EXPORT_DIR="$(readlink -f build)"
                cd $PROJECT_PATH
                godot --headless --verbose --export-release "Linux" "$EXPORT_DIR/linux/$EXPORT_NAME.x86_64"
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: linux
                path: build/linux

    export-android:
        name: Android Export
        runs-on: ubuntu-24.04
        container:
            image: barichello/godot-ci:4.5
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                lfs: true
            - name: Install Java
              run: apt-get update && apt-get install -y openjdk-11-jdk
            - name: Install ADB
              run: apt-get install -y android-tools-adb
            - name: Set Java SDK path
              run: |
                echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))" >> $GITHUB_ENV
            - name: Setup
              run: |
                mkdir -v -p ~/.local/share/godot/export_templates/
                mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
            - name: Android Build
              run: |
                mkdir -v -p build/android
                EXPORT_DIR="$(readlink -f build)"
                cd $PROJECT_PATH
                godot --headless --verbose --export-debug "Android" "$EXPORT_DIR/android/$EXPORT_NAME.apk"
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: android
                path: build/android
    export-web:
        name: Web Export
        runs-on: ubuntu-24.04
        container:
            image: barichello/godot-ci:4.5
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                lfs: true
            - name: Setup
              run: |
                mkdir -v -p ~/.local/share/godot/export_templates/
                mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
            - name: Web Build
              run: |
                mkdir -v -p build/web
                EXPORT_DIR="$(readlink -f build)"
                cd $PROJECT_PATH
                godot --headless --verbose --export-release "Web" "$EXPORT_DIR/web/index.html"
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: web
                path: build/web
            - name: Install rsync ðŸ“š
              run: |
                apt-get update && apt-get install -y rsync
            - name: Deploy to GitHub Pages ðŸš€
              uses: JamesIves/github-pages-deploy-action@releases/v4
              with:
                branch: gh-pages
                folder: build/web
                clean: true

    export-windows:
        name: Windows Export
        runs-on: ubuntu-24.04
        container:
            image: barichello/godot-ci:4.5
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                lfs: true
            - name: Setup
              run: |
                mkdir -v -p ~/.local/share/godot/export_templates/
                mkdir -v -p ~/.config/
                mv /root/.config/godot ~/.config/godot
                mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
            - name: Windows Build
              run: |
                mkdir -v -p build/windows
                EXPORT_DIR="$(readlink -f build)"
                cd $PROJECT_PATH
                godot --headless --verbose --export-release "Windows Desktop" "$EXPORT_DIR/windows/$EXPORT_NAME.exe"
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: windows
                path: build/windows
